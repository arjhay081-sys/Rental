<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Google Analytics GA4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6Y1830Q316"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-6Y1830Q316');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings ‚Äì Bobby's Motorbike Rental</title>
    <meta name="description" content="View and manage your motorbike rental bookings at Bobby's Motorbike Rental, Bantayan Island.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        :root{
            --gold:#f4c430;--teal:#14b878;--green:#25D366;
            --red:#ff6b6b;--orange:#fb923c;
            --bg:#06090f;--card:rgba(255,255,255,0.04);
            --border:rgba(255,255,255,0.09);--muted:#888;
        }
        body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:#fff;min-height:100vh;}
        @keyframes spin{to{transform:rotate(360deg);}}
        @keyframes fadeUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
        @keyframes slideIn{from{opacity:0;transform:translateX(100%);}to{opacity:1;transform:translateX(0);}}

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header{background:rgba(6,9,15,.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;}
        nav{max-width:1100px;margin:0 auto;padding:.75rem 1.25rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;}
        .logo img{height:40px;border-radius:8px;}
        .nav-links{display:flex;align-items:center;gap:.5rem;list-style:none;flex-wrap:wrap;}
        .nav-links a{color:var(--muted);text-decoration:none;font-size:.82rem;font-weight:600;padding:.35rem .65rem;border-radius:8px;transition:all .2s;}
        .nav-links a:hover{color:#fff;background:rgba(255,255,255,.06);}
        .nav-links a.active{color:var(--gold);}
        .nav-links .book-btn{background:linear-gradient(135deg,#f4c430,#ffd700);color:#000!important;padding:.4rem .9rem;border-radius:20px;font-weight:800;}
        .nav-links .book-btn:hover{opacity:.9;background:linear-gradient(135deg,#f4c430,#ffd700);}
        .nav-user{display:flex;align-items:center;gap:.6rem;}
        .nav-user img{width:30px;height:30px;border-radius:50%;border:2px solid var(--gold);}
        .nav-user span{font-size:.8rem;font-weight:700;color:#fff;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .btn-signout{background:transparent;border:1px solid var(--border);color:var(--muted);padding:.3rem .7rem;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;}
        .btn-signout:hover{border-color:rgba(255,107,107,.4);color:var(--red);}
        @keyframes bellRing{0%,100%{transform:rotate(0);}15%{transform:rotate(-18deg);}30%{transform:rotate(18deg);}45%{transform:rotate(-10deg);}60%{transform:rotate(10deg);}}

        /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
        .login-screen{min-height:calc(100vh - 65px);display:flex;align-items:center;justify-content:center;padding:2rem;}
        .login-box{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:2.5rem 2rem;max-width:400px;width:100%;text-align:center;animation:fadeUp .4s ease;}
        .login-box::before{content:'';display:block;width:64px;height:64px;background:rgba(244,196,48,.1);border:1px solid rgba(244,196,48,.3);border-radius:16px;margin:0 auto 1.25rem;background-image:url('BMR.png');background-size:contain;background-repeat:no-repeat;background-position:center;}
        .login-box h2{font-size:1.35rem;font-weight:900;margin-bottom:.5rem;}
        .login-box h2 span{color:var(--gold);}
        .login-box p{color:var(--muted);font-size:.87rem;line-height:1.6;margin-bottom:1.75rem;}
        .btn-google{display:flex;align-items:center;justify-content:center;gap:.75rem;width:100%;background:#fff;color:#1f2937;border:none;padding:.9rem 1.5rem;border-radius:12px;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;box-shadow:0 2px 12px rgba(0,0,0,.3);}
        .btn-google:hover{background:#f8f8f8;transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.4);}
        .btn-google svg{width:22px;height:22px;flex-shrink:0;}
        .login-note{color:#555;font-size:.72rem;margin-top:1rem;line-height:1.5;}

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        .main{max-width:860px;margin:0 auto;padding:1.5rem 1.25rem;}
        .page-header{margin-bottom:1.5rem;animation:fadeUp .35s ease;}
        .page-header h1{font-size:1.5rem;font-weight:900;}
        .page-header h1 span{color:var(--gold);}
        .page-header p{color:var(--muted);font-size:.85rem;margin-top:.3rem;}

        /* ‚îÄ‚îÄ BOOKING CARDS ‚îÄ‚îÄ */
        .bookings-list{display:grid;gap:1rem;}
        .bcard{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--gold);border-radius:16px;overflow:hidden;animation:fadeUp .3s ease both;}
        .bcard.tour{border-left-color:var(--teal);}
        .bcard.approved{border-left-color:var(--green);}
        .bcard.rejected{border-left-color:var(--red);}

        /* card top row */
        .bcard-head{padding:.85rem 1.1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;}
        .bcard-head-left{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;}
        .badge-type{font-size:.6rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:2px 7px;border-radius:5px;}
        .badge-type.bike{background:rgba(244,196,48,.12);color:var(--gold);border:1px solid rgba(244,196,48,.3);}
        .badge-type.tour{background:rgba(20,184,120,.1);color:var(--teal);border:1px solid rgba(20,184,120,.3);}
        .bcard-id{font-size:.92rem;font-weight:800;}
        .badge-status{font-size:.6rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:2px 9px;border-radius:20px;}
        .badge-status.pending{background:rgba(251,146,60,.12);color:var(--orange);border:1px solid rgba(251,146,60,.3);}
        .badge-status.approved{background:rgba(37,211,102,.1);color:var(--green);border:1px solid rgba(37,211,102,.3);}
        .badge-status.rejected{background:rgba(255,107,107,.1);color:var(--red);border:1px solid rgba(255,107,107,.3);}

        /* card body */
        .bcard-body{padding:.85rem 1.1rem;display:grid;grid-template-columns:1fr 1fr;gap:.6rem;}
        .cf label{display:block;color:var(--muted);font-size:.62rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;}
        .cf span{color:#fff;font-size:.84rem;font-weight:600;}
        .cf span.gold{color:var(--gold);}
        .cf span.teal{color:var(--teal);}
        .cf span.green{color:var(--green);}
        .cf span.red{color:var(--red);}
        .cf span.orange{color:var(--orange);}

        /* admin note */
        .admin-note{margin:.5rem 1.1rem .75rem;padding:.65rem .85rem;background:rgba(37,211,102,.07);border:1px solid rgba(37,211,102,.2);border-radius:10px;font-size:.8rem;color:#aaa;font-style:italic;line-height:1.5;}
        .admin-note strong{color:var(--green);font-style:normal;}

        /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
        .chat-section{border-top:1px solid var(--border);}
        .chat-toggle{width:100%;background:none;border:none;padding:.7rem 1.1rem;display:flex;align-items:center;justify-content:space-between;cursor:pointer;color:var(--muted);font-size:.8rem;font-weight:700;transition:all .2s;}
        .chat-toggle:hover{color:#fff;background:rgba(255,255,255,.03);}
        .chat-toggle-left{display:flex;align-items:center;gap:.5rem;}
        .chat-toggle svg{width:14px;height:14px;fill:currentColor;}
        .chat-badge{background:var(--red);color:#fff;font-size:.6rem;font-weight:900;padding:1px 6px;border-radius:10px;min-width:18px;text-align:center;}
        .chat-arrow{width:12px;height:12px;fill:currentColor;transition:transform .25s;}
        .chat-toggle.open .chat-arrow{transform:rotate(180deg);}

        .chat-body{display:none;flex-direction:column;height:300px;}
        .chat-body.open{display:flex;}
        .chat-messages{flex:1;overflow-y:auto;padding:.75rem 1rem;display:flex;flex-direction:column;gap:.5rem;scroll-behavior:smooth;}
        .chat-messages::-webkit-scrollbar{width:4px;}
        .chat-messages::-webkit-scrollbar-track{background:transparent;}
        .chat-messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px;}
        .msg{max-width:80%;display:flex;flex-direction:column;gap:2px;}
        .msg.mine{align-self:flex-end;align-items:flex-end;}
        .msg.theirs{align-self:flex-start;align-items:flex-start;}
        .msg-bubble{padding:.5rem .8rem;border-radius:14px;font-size:.83rem;line-height:1.5;word-break:break-word;}
        .msg.mine .msg-bubble{background:rgba(244,196,48,.18);border:1px solid rgba(244,196,48,.25);color:#fff;border-radius:14px 14px 4px 14px;}
        .msg.theirs .msg-bubble{background:rgba(255,255,255,.07);border:1px solid var(--border);color:#ddd;border-radius:14px 14px 14px 4px;}
        .msg-meta{font-size:.62rem;color:#555;}
        .chat-empty{text-align:center;color:#444;font-size:.8rem;margin:auto;padding:1rem;}
        .chat-input-row{padding:.65rem .85rem;border-top:1px solid var(--border);display:flex;gap:.5rem;}
        .chat-input{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:10px;padding:.5rem .85rem;color:#fff;font-size:.85rem;font-family:inherit;outline:none;transition:border-color .2s;}
        .chat-input:focus{border-color:rgba(244,196,48,.4);}
        .chat-input::placeholder{color:#444;}
        .chat-send{background:var(--gold);border:none;color:#000;width:36px;height:36px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity .2s;}
        .chat-send:hover{opacity:.85;}
        .chat-send svg{width:16px;height:16px;fill:#000;}
        .chat-send:disabled{opacity:.3;cursor:not-allowed;}

        /* ‚îÄ‚îÄ STATES ‚îÄ‚îÄ */
        .state-box{text-align:center;padding:3.5rem 1.5rem;color:var(--muted);}
        .state-box svg{width:40px;height:40px;fill:currentColor;opacity:.2;display:block;margin:0 auto 1rem;}
        .state-box h3{font-size:1rem;color:#666;margin-bottom:.4rem;}
        .state-box a{color:var(--gold);text-decoration:none;font-weight:700;}
        .spinner{width:28px;height:28px;border:3px solid rgba(244,196,48,.15);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:2.5rem auto;}

        /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
        @media(max-width:600px){
            .bcard-body{grid-template-columns:1fr;}
            .nav-links{display:none;}
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header>
    <nav>
        <a href="index.html" class="logo"><img src="BMR.png" alt="BMR"></a>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="blog.html">Blog</a></li>
            <li><a href="tour.html">Tours</a></li>
            <li><a href="faq.html">FAQ</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="my-bookings.html" class="active">My Bookings</a></li>
            <li><a href="booking.html" class="book-btn">Book Now</a></li>
        </ul>
        <div class="nav-user" id="nav-user" style="display:none;">
            <img id="nav-avatar" src="" alt="">
            <span id="nav-name"></span>
            <button class="btn-signout" onclick="signOut()">Sign out</button>
        </div>
    </nav>
</header>

<!-- LOGIN SCREEN (shown when not logged in) -->
<div id="login-screen" class="login-screen" style="display:none;">
    <div class="login-box">
        <h2>My <span>Bookings</span></h2>
        <p>Sign in with your Google account to view your bookings, check your status, and chat with the BMR team.</p>
        <button class="btn-google" onclick="signInGoogle()">
            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continue with Google
        </button>
        <div class="login-note">Your Google info is only used to link your bookings.<br>We never post on your behalf.</div>
    </div>
</div>

<!-- MAIN PORTAL (shown when logged in) -->
<div id="portal" class="main" style="display:none;">
    <div class="page-header">
        <h1>My <span>Bookings</span></h1>
        <p id="portal-sub">Loading your bookings‚Ä¶</p>
    </div>
    <div class="bookings-list" id="bookings-list">
        <div class="spinner"></div>
    </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ
firebase.initializeApp({
    apiKey:            'AIzaSyCG1hOzMXJDQCcj-_OlmYBu9mV8xdN15bI',
    authDomain:        'bobbys-motorbike-rental.firebaseapp.com',
    projectId:         'bobbys-motorbike-rental',
    storageBucket:     'bobbys-motorbike-rental.firebasestorage.app',
    messagingSenderId: '22999361272',
    appId:             '1:22999361272:web:3f2abf58faf2e8f8e3fd0d'
});
var auth     = firebase.auth();
var db       = firebase.firestore();
var provider = new firebase.auth.GoogleAuthProvider();

// ‚îÄ‚îÄ SIGN IN / OUT ‚îÄ‚îÄ
function signInGoogle() {
    auth.signInWithPopup(provider).catch(function(e) {
        alert('Sign-in failed: ' + e.message);
    });
}
function signOut() {
    auth.signOut();
}

// ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ
var currentUser   = null;
var chatListeners = {};
var bookingListeners = [];

auth.onAuthStateChanged(function(user) {
    currentUser = user;
    if (!user) {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('portal').style.display = 'none';
        document.getElementById('nav-user').style.display = 'none';
        // Detach listeners
        bookingListeners.forEach(function(u){ u(); });
        bookingListeners = [];
        Object.values(chatListeners).forEach(function(u){ u(); });
        chatListeners = {};
        return;
    }
    // Logged in
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('portal').style.display = 'block';
    document.getElementById('nav-user').style.display = 'flex';
    document.getElementById('nav-avatar').src = user.photoURL || '';
    document.getElementById('nav-name').textContent = user.displayName || user.email;
    loadMyBookings(user.uid);
});

// ‚îÄ‚îÄ LOAD BOOKINGS ‚îÄ‚îÄ
function loadMyBookings(uid) {
    var list = document.getElementById('bookings-list');
    list.innerHTML = '<div class="spinner"></div>';

    var bikes = [];
    var tours = [];
    var bikeLoaded = false;
    var tourLoaded = false;

    function merge() {
        if (!bikeLoaded || !tourLoaded) return;
        var all = bikes.concat(tours);
        all.sort(function(a, b) {
            var at = a.createdAt ? a.createdAt.toMillis() : 0;
            var bt = b.createdAt ? b.createdAt.toMillis() : 0;
            return bt - at;
        });
        document.getElementById('portal-sub').textContent =
            all.length + ' booking' + (all.length !== 1 ? 's' : '') + ' found';
        if (!all.length) {
            list.innerHTML =
                '<div class="state-box">' +
                '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>' +
                '<h3>No bookings yet</h3>' +
                '<p>Ready to explore Bantayan Island?</p>' +
                '<a href="booking.html" style="display:inline-block;margin-top:1rem;background:var(--gold);color:#000;padding:.6rem 1.5rem;border-radius:20px;font-weight:800;text-decoration:none;">Book a Bike</a>' +
                '&nbsp;&nbsp;<a href="tour.html" style="display:inline-block;margin-top:1rem;background:var(--teal);color:#fff;padding:.6rem 1.5rem;border-radius:20px;font-weight:800;text-decoration:none;">Book a Tour</a>' +
                '</div>';
            return;
        }
        list.innerHTML = all.map(buildCard).join('');
        // Attach chat listeners for each booking
        all.forEach(function(d) {
            attachChatListener(d._id, uid);
        });
    }

    // Bike bookings
    var u1 = db.collection('bookings').where('userUID', '==', uid)
        .onSnapshot(function(snap) {
            bikes = snap.docs.map(function(d) {
                return Object.assign({}, d.data(), { _id: d.id, _type: 'bike' });
            });
            bikeLoaded = true;
            merge();
        }, function(e) {
            bikeLoaded = true;
            console.error('Bike load error:', e);
            merge();
        });

    // Tour bookings
    var u2 = db.collection('tour_bookings').where('userUID', '==', uid)
        .onSnapshot(function(snap) {
            tours = snap.docs.map(function(d) {
                return Object.assign({}, d.data(), { _id: d.id, _type: 'tour' });
            });
            tourLoaded = true;
            merge();
        }, function(e) {
            tourLoaded = true;
            console.error('Tour load error:', e);
            merge();
        });

    bookingListeners = [u1, u2];
}

// ‚îÄ‚îÄ BUILD CARD ‚îÄ‚îÄ
function buildCard(d) {
    var isBike = d._type === 'bike';
    var st     = d.status || 'pending';
    var stCap  = st.charAt(0).toUpperCase() + st.slice(1);
    var note   = d.adminNotes ? '<div class="admin-note"><strong>üí¨ BMR Team:</strong> "' + esc(d.adminNotes) + '"</div>' : '';

    var fields = isBike
        ? '<div class="cf"><label>Bike</label><span class="gold">' + esc(d.bikeName) + '</span></div>' +
          '<div class="cf"><label>Date</label><span>' + esc(d.formattedDate || '‚Äì') + '</span></div>' +
          '<div class="cf"><label>Duration</label><span>' + esc(d.rentalDays) + ' day(s)</span></div>' +
          '<div class="cf"><label>Bikes</label><span>' + esc(d.numBikes) + '</span></div>' +
          '<div class="cf"><label>Total</label><span class="gold">‚Ç±' + Number(d.totalPrice||0).toLocaleString() + '</span></div>' +
          '<div class="cf"><label>Status</label><span class="' + stClass(st) + '">' + stCap + '</span></div>'
        : '<div class="cf"><label>Tour Date</label><span class="teal">' + esc(d.formattedDate || '‚Äì') + '</span></div>' +
          '<div class="cf"><label>Start Time</label><span>' + esc(d.startTime || '‚Äì') + '</span></div>' +
          '<div class="cf"><label>Duration</label><span>8 Hours</span></div>' +
          '<div class="cf"><label>Total</label><span class="teal">‚Ç±840</span></div>' +
          '<div class="cf"><label>Status</label><span class="' + stClass(st) + '">' + stCap + '</span></div>' +
          '<div class="cf"><label>Requests</label><span>' + esc(d.stops || 'None') + '</span></div>';

    return '<div class="bcard ' + (isBike ? 'bike' : 'tour') + ' ' + st + '" id="bcard-' + d._id + '">' +
        '<div class="bcard-head">' +
            '<div class="bcard-head-left">' +
                '<span class="badge-type ' + (isBike ? 'bike' : 'tour') + '">' + (isBike ? 'üèç Bike' : 'üö∂ Tour') + '</span>' +
                '<span class="bcard-id">' + esc(d.bookingID || d._id) + '</span>' +
                '<span class="badge-status ' + st + '">' + stCap + '</span>' +
            '</div>' +
            '<span style="color:var(--muted);font-size:.7rem;">' + timeAgo(d.createdAt) + '</span>' +
        '</div>' +
        '<div class="bcard-body">' + fields + '</div>' +
        note +
        '<div class="chat-section">' +
            '<button class="chat-toggle" id="ct-' + d._id + '" onclick="toggleChat(\'' + d._id + '\')">' +
                '<div class="chat-toggle-left">' +
                    '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>' +
                    'Chat with BMR Team' +
                    '<span class="chat-badge" id="badge-' + d._id + '" style="display:none">0</span>' +
                '</div>' +
                '<svg class="chat-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>' +
            '</button>' +
            '<div class="chat-body" id="cb-' + d._id + '">' +
                '<div class="chat-messages" id="cm-' + d._id + '">' +
                    '<div class="chat-empty">No messages yet. Say hello to the BMR team! üëã</div>' +
                '</div>' +
                '<div class="chat-input-row">' +
                    '<input class="chat-input" id="ci-' + d._id + '" placeholder="Type a message‚Ä¶" onkeydown="chatKeydown(event,\'' + d._id + '\')" maxlength="500">' +
                    '<button class="chat-send" onclick="sendMsg(\'' + d._id + '\')">' +
                        '<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>' +
                    '</button>' +
                '</div>' +
            '</div>' +
        '</div>' +
    '</div>';
}

function stClass(st) {
    return st === 'approved' ? 'green' : st === 'rejected' ? 'red' : 'orange';
}
function esc(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function timeAgo(ts) {
    if (!ts || !ts.toMillis) return '';
    var m = Math.floor((Date.now() - ts.toMillis()) / 60000);
    if (m < 1)  return 'Just now';
    if (m < 60) return m + 'm ago';
    var h = Math.floor(m / 60);
    if (h < 24) return h + 'h ago';
    return Math.floor(h / 24) + 'd ago';
}

// ‚îÄ‚îÄ CHAT TOGGLE ‚îÄ‚îÄ
function toggleChat(id) {
    var btn  = document.getElementById('ct-' + id);
    var body = document.getElementById('cb-' + id);
    var open = btn.classList.toggle('open');
    body.classList.toggle('open', open);
    if (open) {
        // Mark messages read
        markRead(id);
        // Scroll to bottom
        var cm = document.getElementById('cm-' + id);
        if (cm) cm.scrollTop = cm.scrollHeight;
    }
}

// ‚îÄ‚îÄ CHAT LISTENER (real-time) ‚îÄ‚îÄ
function attachChatListener(bookingId, uid) {
    if (chatListeners[bookingId]) return; // already attached
    var unsub = db.collection('chats').doc(bookingId).collection('messages')
        .orderBy('createdAt', 'asc')
        .onSnapshot(function(snap) {
            renderMessages(bookingId, snap.docs, uid);
            // Count unread (admin messages not yet read by customer)
            var unread = snap.docs.filter(function(d) {
                var m = d.data();
                return m.senderType === 'admin' && !m.readByCustomer;
            }).length;
            var badge = document.getElementById('badge-' + bookingId);
            if (badge) {
                badge.textContent = unread;
                badge.style.display = unread > 0 ? 'inline-block' : 'none';
            }
        }, function(e) { console.warn('Chat listener error:', e.code); });
    chatListeners[bookingId] = unsub;
}

function renderMessages(bookingId, docs, uid) {
    var cm = document.getElementById('cm-' + bookingId);
    if (!cm) return;
    if (!docs.length) {
        cm.innerHTML = '<div class="chat-empty">No messages yet. Say hello to the BMR team! üëã</div>';
        return;
    }
    cm.innerHTML = docs.map(function(d) {
        var m    = d.data();
        var mine = m.senderUID === uid;
        var time = m.createdAt ? new Date(m.createdAt.toMillis()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
        return '<div class="msg ' + (mine ? 'mine' : 'theirs') + '">' +
            '<div class="msg-bubble">' + esc(m.text) + '</div>' +
            '<div class="msg-meta">' + (mine ? 'You' : 'üèç BMR Team') + ' ¬∑ ' + time + '</div>' +
        '</div>';
    }).join('');
    // Auto-scroll if chat is open
    var btn = document.getElementById('ct-' + bookingId);
    if (btn && btn.classList.contains('open')) {
        cm.scrollTop = cm.scrollHeight;
    }
}

function markRead(bookingId) {
    if (!currentUser) return;
    db.collection('chats').doc(bookingId).collection('messages')
        .where('senderType', '==', 'admin')
        .where('readByCustomer', '==', false)
        .get().then(function(snap) {
            if (snap.empty) return;
            var batch = db.batch();
            snap.docs.forEach(function(d) { batch.update(d.ref, { readByCustomer: true }); });
            batch.commit().catch(function(){});
        }).catch(function(){});
}

// ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ
function chatKeydown(e, id) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(id); }
}

function sendMsg(bookingId) {
    if (!currentUser) return;
    var input = document.getElementById('ci-' + bookingId);
    var text  = (input.value || '').trim();
    if (!text) return;
    input.value = '';
    db.collection('chats').doc(bookingId).collection('messages').add({
        text:           text,
        senderUID:      currentUser.uid,
        senderName:     currentUser.displayName || currentUser.email,
        senderType:     'customer',
        readByAdmin:    false,
        readByCustomer: true,
        createdAt:      firebase.firestore.FieldValue.serverTimestamp()
    }).catch(function(e) {
        input.value = text;
        console.error('Send error:', e);
        alert('Could not send message. Please try again.');
    });
}
</script>
</body>
</html>
